# 项目使用须知

该项目由b站up主Cc专心破译设计，并与多为志同道合的大佬完成后续开发，代码仅供学习交流使用，禁止商用，包括但不限于售卖、盈利性估价、直播等。

项目基于本地数据库制作，已在database中设置一个例子，由于价格具有时效性，所以不要盲目直接使用该项目进行估价。

启动项目后会生成一个网页，可以拖入图片进入该网页实现自动估价与标注

# 临时环境搭建教程

##  前置知识
可以搜索anaconda或者miniconda教程

为vscode装上anaconda或者miniconda来管理虚拟环境

## 创建虚拟环境并安装依赖

```
conda create -n cbg python=3.11
conda activate cbg
pip install -r requirements.txt
```

## Usage

根据 `config.py` 文件设置数据库信息 (或者根据数据库位置设置 `config` 的信息):

1. 在 `database` 文件夹中创建 `pic` 文件夹, 并放入小图.
2. 在 `database` 文件夹中创建 `name_id.csv` 文件, 并放入小图ID与名称的映射关系.
3. 在 `database` 文件夹中创建 `第五人格藏宝阁制作版2025年3月30日.xlsx` 文件, 并放入藏宝阁数据.
4. 在 `database` 文件夹中创建 `cloth.csv` 文件, 并放入侦探服装数据.

然后运行 `main.py` 文件, 即可开始估价.

```
python main.py
```

开启网页客户端后, 上传的图片会保存在 `input/<时间戳>` 文件夹中, 经过模式匹配后保存在 `output/<同一个时间戳>` 文件夹下.

## 特征提取技术

> [!NOTE]
> 为什么不使用神经网络？
> 
> 1. 本项目不要求图像识别具有良好的泛化性, 只需要模版匹配即可
> 2. 神经网络的训练需要大量数据, 而本项目的数据量较小, 容易造成过拟合

本项目主要采用基于特征点的图像匹配技术来识别游戏截图中的物品图标。具体步骤如下：

1.  **特征提取与匹配**: 使用 SIFT 算法提取模板图像（数据库中的小图）和待检测图像（用户上传的截图）的特征点及其描述符。然后，使用 K 最近邻 (KNN) 算法在特征空间中寻找匹配对。
2.  **比率测试 (Lowe's Ratio Test)**: 为了筛选出更可靠的匹配点对，应用了 Lowe's 比率测试。通过比较最近邻和次近邻的距离比值，可以有效剔除模糊匹配。`lowe_ratio_test_threshold` 参数用于控制筛选的严格程度，因为我们是严格的匹配已有的图片，所以我们采用了较小的值，意味着只有非常相似的特征点才会被保留，产生更少但更可靠的匹配。
3.  **几何验证与评分**:
    *   **单应性矩阵 (Homography)**: 对通过比率测试的匹配点对，使用 RANSAC 算法估计一个单应性矩阵，该矩阵描述了模板图像到待检测图像的透视变换。
    *   **内点 (Inliers)**: 在 RANSAC 过程中，能够较好地符合估计出的单应性变换的匹配点被称为内点。内点的数量或比例反映了匹配在几何上的一致性。
    *   **综合评分 (Score Function)**: 为了更准确地评估匹配质量，我们设计了一个综合评分函数。该函数将通过比率测试的 KNN 匹配的数量与单应性变换的内点比例相乘。这样做的好处是同时考虑了特征空间的相似性（匹配点数）和几何空间的一致性（内点比例），从而得到更鲁棒的匹配评分。
4.  **矩形区域检测与过滤**: 在找到潜在匹配区域后，会检测该区域是否近似为矩形。如果检测到的边界框形状与矩形差异过大，则认为该匹配无效并将其删除，以排除错误的或变形严重的匹配结果。
5.  **非极大值抑制 (NMS)**: 由于模板图像可能在待检测图像中出现多次，或者多个不同的模板图像匹配到同一区域，可能会产生重叠的检测框 (Bounding Box)。为了解决这个问题，我们计算重叠检测框之间的交并比 (Intersection over Union, IoU)，并应用非极大值抑制 (NMS) 算法。NMS 会保留得分最高的检测框，并抑制掉与其重叠度较高且得分较低的其他检测框，确保每个物品只被识别一次，且保留的是最佳匹配结果。

## 二次开发

如果您对这个项目感兴趣，欢迎一起完善本项目。我的微信号是
```
itctlsssr
```
欢迎添加我的微信，并成为开发团队的一员。
